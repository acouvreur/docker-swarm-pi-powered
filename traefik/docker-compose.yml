version: "3.7"

services:

  #-------------------------------------#
  # Traefik : reverse proxy with HTTPS
  #-------------------------------------#
  traefik:
    hostname: traefik
    image: traefik:latest
    command:
      --certificatesresolvers.ovh.acme.dnschallenge=true
    networks:
      - traefik
    ports:
      - "80:80"
      - "443:443"
    environment:
    # You can pass environment variables from your shell straight through to a service’s containers
    # with the ‘environment’ key by not giving them a value, just like with docker run -e VARIABLE ...
      - OVH_ENDPOINT
      - OVH_APPLICATION_KEY
      - OVH_APPLICATION_SECRET
      - OVH_CONSUMER_KEY
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - $PWD:/etc/traefik
    deploy:
      labels:
        - traefik.enable=true
        - traefik.http.routers.traefik.rule=Host(`traefik.${DOMAINNAME}`)
        - traefik.http.routers.traefik.service=api@internal
        - traefik.http.routers.traefik.entrypoints=https
        - traefik.http.routers.traefik.middlewares=default-auth
        - traefik.http.routers.traefik.tls.domains[0].main=${DOMAINNAME}
        - traefik.http.routers.traefik.tls.domains[0].sans=*.${DOMAINNAME}
        - traefik.http.routers.traefik.tls.certresolver=ovh
      replicas: 1
      placement:
        constraints: [node.role==manager]

networks:
  traefik:
    external: true
    name: traefik
